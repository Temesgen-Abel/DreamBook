<!DOCTYPE html>
<html lang="en">
<head>
  <%- include("includes/head", {
    title: title || "Dream Dictionary A–Z | DreamBook",
    description: description || "Search and explore dream meanings from A to Z using the DreamBook dictionary.",
    canonical: canonical || "https://dreambook.com.et/dictionary"
  }) %>
</head>

<body class="dictionary-page">

<%- include("includes/header") %>

<main class="wrapper">

  <!-- PAGE HEADER -->
  <header class="page-header">
    <h1>Dream Dictionary A–Z</h1>
    <p>Explore and contribute to our growing collection of dream meanings.</p>
  </header>

  <!-- ERROR MESSAGES -->
  <% if (errors && errors.length) { %>
    <div class="alert error">
      <% errors.forEach(e => { %>
        <p><%= e %></p>
      <% }) %>
    </div>
  <% } %>

  <!-- SUCCESS MESSAGE -->
  <!-- SUCCESS MESSAGE -->
<% if (success === "added") { %>
  <div class="alert success">
    Thank you! Your dream meaning has been added ✔️
  </div>
<% } %>
<% if (success === "updated") { %>
  <div class="alert success">
    Dream meaning updated successfully ✔️
  </div>
<% } %>
<% if (success === "deleted") { %>
  <div class="alert success">
    Dream meaning deleted successfully ✔️
  </div>
<% } %>

  <!-- ADD DREAM MEANING (ALL USERS) -->
  <section class="dictionary-add">
    <h2>Contribute a Dream Meaning</h2>
    <p>Share your understanding of dream symbols to help others.</p>

    <form action="/dictionary/add" method="POST" class="dream-analyzer-form">
      <label for="term">Dream Symbol</label>
      <input
        type="text"
        id="term"
        name="term"
        placeholder="e.g. snake, water, flying"
        required
      >

      <label for="meaning">Dream Meaning</label>
      <textarea
        id="meaning"
        name="meaning"
        placeholder="Describe the meaning of this dream symbol..."
        required
      ></textarea>

      <button class="btn" type="submit">Submit Meaning</button>
    </form>
  </section>

  <!-- SEARCH -->
  <!-- SEARCH -->
<section class="dictionary-search">
  <h2>Search Dream Meanings</h2>

  <form action="/dictionary" method="GET">
    <input
      type="text"
      id="search"
      name="q"
      placeholder="Search a dream symbol..."
      autocomplete="off"
      value="<%= searchQuery || '' %>"
      required
    >
    <button class="btn">Search</button>
  </form>

  <!-- DISPLAY SEARCH RESULTS IF SEARCH QUERY EXISTS -->
  <% if (searchQuery && terms.length) { %>
    <h3>Results for "<%= searchQuery %>":</h3>
    <ul class="search-results">
      <% terms.forEach(t => { %>
        <li>
          <strong><%= t.term %></strong>: <%= t.meaning %>
        </li>
      <% }) %>
    </ul>
  <% } else if (searchQuery && !terms.length) { %>
    <p>No results found for "<%= searchQuery %>".</p>
  <% } %>

  <!-- LIVE SEARCH RESULTS -->
  <ul id="liveResults" class="live-results"></ul>
</section>

  <!-- DICTIONARY LIST -->
  <section class="dictionary-list">
    <h2>Dictionary Entries</h2>

    <% if (!terms || !terms.length) { %>
      <p>No dream meanings added yet.</p>
    <% } %>

    <article
  class="dictionary-item"
  <%= (user && user.role === "admin")
      ? `onclick="toggleAdmin('${t.id}')" style="cursor:pointer;"`
      : "" %>
>
  <h3><%= t.term %></h3>
  <p><%= t.meaning %></p>

  <% if (user && user.role === "admin") { %>
    <div
      class="admin-controls"
      id="admin-<%= t.id %>"
      style="display:none;"
      onclick="event.stopPropagation();"
    >
      <form action="/dictionary/<%= t.id %>/edit" method="POST">
        <input type="text" name="term" value="<%= t.term %>" required>
        <textarea name="meaning" required><%= t.meaning %></textarea>
        <button class="btn small">Update</button>
      </form>

      <form
        action="/dictionary/<%= t.id %>/delete"
        method="POST"
        onsubmit="return confirm('Are you sure you want to delete this meaning?');"
      >
        <button class="btn danger small">Delete</button>
      </form>
    </div>
  <% } %>
</article>

</main>

<!-- LIVE SEARCH SCRIPT -->
<script>
  const input = document.getElementById("search");
  const resultsBox = document.getElementById("liveResults");
  let timer;

  input.addEventListener("input", () => {
    clearTimeout(timer);
    const q = input.value.trim();
    if (!q) {
      resultsBox.innerHTML = "";
      return;
    }

    timer = setTimeout(async () => {
      try {
        const res = await fetch("/dictionary/live?q=" + encodeURIComponent(q));
        const data = await res.json();

        resultsBox.innerHTML = data.map(d =>
          `<li>
            <strong>${d.term}</strong>
          </li>`
        ).join("");
      } catch (err) {
        console.error("Live search failed");
      }
    }, 300);
  });
</script>

<script>
  function toggleAdmin(id) {
    const el = document.getElementById("admin-" + id);

    // close others
    document.querySelectorAll(".admin-controls").forEach(div => {
      if (div !== el) div.style.display = "none";
    });

    el.style.display = el.style.display === "none" ? "block" : "none";
  }
</script>

</body>
<%- include("includes/footer") %>
</html>
