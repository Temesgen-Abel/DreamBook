<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <%- include("includes/head", {
    title: title || "Dream Dictionary | DreamBook",
    description: description || "Search and explore dream meanings from A to Z using the DreamBook dictionary.",
    canonical: canonical || "https://dreambook.com.et/dictionary"
  }) %>
</head>

<body class="dictionary-page">

<%- include("includes/header") %>

<main class="wrapper">

  <!-- PAGE HEADER -->
  <header class="page-header">
    <h1><%= t?.dictionaryTitle || "Dream Dictionary" %></h1>
    <p>Explore and contribute to our growing collection of dream meanings.</p>
  </header>

  <!-- ERROR MESSAGES -->
  <% if (errors && errors.length) { %>
    <div class="alert error">
      <% errors.forEach(e => { %>
        <p><%= e %></p>
      <% }) %>
    </div>
  <% } %>

  <!-- SUCCESS MESSAGES -->
  <% if (success === "added") { %>
    <div class="alert success">Thank you! Your dream meaning has been added ✔️</div>
  <% } %>
  <% if (success === "updated") { %>
    <div class="alert success">Dream meaning updated successfully ✔️</div>
  <% } %>
  <% if (success === "deleted") { %>
    <div class="alert success">Dream meaning deleted successfully ✔️</div>
  <% } %>

  <!-- ADD DREAM MEANING -->
  <section class="dictionary-add">
    <h2>Contribute a Dream Meaning</h2>
    <p>Share your understanding of dream symbols to help others.</p>

    <form action="/dictionary/add" method="POST" class="dream-analyzer-form">
      <label for="term">Dream Symbol</label>
      <input id="term" name="term" required>
 
      <label for="meaning">Dream Meaning</label>
      <textarea id="meaning" name="meaning" required></textarea>

      <label for="lang">Language</label>
      <select id="lang" name="lang" required>
        <option value="en" <%= lang === "en" ? "selected" : "" %>>English</option>
        <option value="am" <%= lang === "am" ? "selected" : "" %>>አማርኛ</option>
      </select>

      <button class="btn">Submit Meaning</button>
    </form>
  </section>

  <!-- SEARCH -->
  <section class="dictionary-search">
    <h2>Search Dream Meanings</h2>

    <form action="/dictionary" method="GET">
      <input
        id="search"
        name="q"
        value="<%= searchQuery || '' %>"
        autocomplete="off"
        required
      >
      <input type="hidden" name="lang" value="<%= lang %>">
      <button class="btn">Search</button>
    </form>

    <ul id="liveResults" class="live-results"></ul>
  </section>

  <!-- DICTIONARY LIST -->
  <section class="dictionary-list">

    <% if (!terms || !terms.length) { %>
      <p>No dream meanings added yet.</p>
    <% } %>

    <% terms.forEach(t => { %>
      <article class="dictionary-entry">

        <h3>
          <%= lang === "am"
            ? (t.term_am || t.term_en)
            : (t.term_en || t.term_am)
          %>
        </h3>

        <p>
          <%= lang === "am"
            ? (t.meaning_am || t.meaning_en)
            : (t.meaning_en || t.meaning_am)
          %>
        </p>

        <!-- TRANSLATION LINKS -->
        <% if (lang === "am" && !t.term_am) { %>
          <a href="/dictionary/<%= t.id %>/translate?to=am" class="btn small">
            ትርጉም አክል
          </a>
        <% } %>

        <% if (lang === "en" && !t.term_en) { %>
          <a href="/dictionary/<%= t.id %>/translate?to=en" class="btn small">
            Add Translation
          </a>
        <% } %>

        <!-- ADMIN CONTROLS -->
        <% if (user && user.role === "admin") { %>
          <button class="btn small" onclick="toggleAdmin('<%= t.id %>')">
           ⚙️
          </button>

          <div class="admin-controls" id="admin-<%= t.id %>" style="display:none;">
            <form action="/dictionary/<%= t.id %>/edit" method="POST">
              <input type="hidden" name="lang" value="<%= lang %>">
              <input name="term" value="<%= lang === 'am' ? t.term_am : t.term_en %>" required>
              <textarea name="meaning" required><%= lang === 'am' ? t.meaning_am : t.meaning_en %></textarea>
              <button type="submit" class="btn small">Update</button>
               <% if (success === "updated") { %>
          <div class="alert success"> Successfully updated✔️</div>
            <% } %>
            </form>

            <form
              action="/dictionary/<%= t.id %>/delete"
              method="POST"
              onsubmit="return confirm('Are you sure you want to delete this meaning?');"
            >
              <button type="submit" class="btn danger small">Delete</button>
            </form>
          </div>
        <% } %>

      </article>
    <% }) %>

  </section>

  <form action="/dashboard" method="get">
    <button type="submit" class="btn">Back to Homepage</button>
  </form>

</main>

<!-- EXPOSE LANG TO JS -->
<script>
  const lang = "<%= lang %>";
</script>

<!-- LIVE SEARCH SCRIPT -->
<script>
  const input = document.getElementById("search");
  const resultsBox = document.getElementById("liveResults");
  let timer;

  input.addEventListener("input", () => {
    clearTimeout(timer);
    const q = input.value.trim();
    if (!q) { resultsBox.innerHTML = ""; return; }

    timer = setTimeout(async () => {
      const res = await fetch("/dictionary/live?q=" + encodeURIComponent(q) + "&lang=" + lang);
      const data = await res.json();

      resultsBox.innerHTML = data.map(d => `
        <li>
          <strong>${lang === "am" ? (d.term_am || d.term_en) : (d.term_en || d.term_am)}</strong>
        </li>
      `).join("");
    }, 300);
  });

  function toggleAdmin(id) {
    const el = document.getElementById("admin-" + id);
    if (el.style.display === "block") return;
    document.querySelectorAll(".admin-controls").forEach(d => d.style.display = "none");
    el.style.display = "block";
  }
</script>


</body>
<%- include("includes/footer") %>
</html>
