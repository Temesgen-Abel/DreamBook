<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <%- include("includes/head", {
    title: title || "Dream Dictionary | DreamBook",
    description: description || "Search and explore dream meanings from A to Z using the DreamBook dictionary.",
    canonical: canonical || "https://dreambook.com.et/dictionary"
  }) %>
</head>

<body class="dictionary-page">

<%- include("includes/header") %>

<main class="wrapper">

  <!-- PAGE HEADER -->
  <header class="page-header">
    <h1>Dream Dictionary </h1>
    <p>Explore and contribute to our growing collection of dream meanings.</p>
  </header>

  <!-- ERROR MESSAGES -->
  <% if (errors && errors.length) { %>
    <div class="alert error">
      <% errors.forEach(e => { %>
        <p><%= e %></p>
      <% }) %>
    </div>
  <% } %>

  <!-- SUCCESS MESSAGES -->
  <% if (success === "added") { %>
    <div class="alert success">Thank you! Your dream meaning has been added ✔️</div>
  <% } %>
  <% if (success === "updated") { %>
    <div class="alert success">Dream meaning updated successfully ✔️</div>
  <% } %>
  <% if (success === "deleted") { %>
    <div class="alert success">Dream meaning deleted successfully ✔️</div>
  <% } %>

  <!-- ADD DREAM MEANING -->
  <section class="dictionary-add">
    <h2>Contribute a Dream Meaning</h2>
    <p>Share your understanding of dream symbols to help others.</p>

    <form action="/dictionary/add" method="POST" class="dream-analyzer-form" >
      <label for="term">Dream Symbol</label>
      <input id="term" name="term" required>

      <label for="meaning">Dream Meaning</label>
      <textarea id="meaning" name="meaning" required></textarea>

      <button class="btn">Submit Meaning</button>
    </form>
  </section>

  <!-- SEARCH -->
  <section class="dictionary-search">
    <h2>Search Dream Meanings</h2>

    <form action="/dictionary" method="GET">
      <input
        id="search"
        name="q"
        value="<%= searchQuery || '' %>"
        autocomplete="off"
        required
      >
      <button class="btn">Search</button>
    </form>

    <% if (searchQuery && terms.length) { %>
      <h3>Results for "<%= searchQuery %>":</h3>
      <ul class="search-results">
        <% terms.forEach(t => { %>
          <li><strong><%= t.term %></strong>: <%= t.meaning %></li>
        <% }) %>
      </ul>
    <% } else if (searchQuery && !terms.length) { %>
      <p>No results found.</p>
    <% } %>

    <ul id="liveResults" class="live-results"></ul>
  </section>

  <!-- DICTIONARY LIST -->
  <section class="dictionary-list">
    <h2>Dictionary Entries</h2>

    <% if (!terms || !terms.length) { %>
      <p>No dream meanings added yet.</p>
    <% } %>

    <% terms.forEach(t => { %>
      <article class="dictionary-item">
     <h3
            <% if (user && user.role === "admin") { %>
              onclick="toggleAdmin('<%= t.id %>')"
              style="cursor:pointer;"
            <% } %>
          >
            <%= t.term %> = <%= t.meaning %>
      </h3>


        <% if (user && user.role === "admin") { %>
          <div
         
                class="admin-controls"
                id="admin-<%= t.id %>"
                style="display:none;"
              >
                <form action="/dictionary/<%= t.id %>/edit" method="POST">
                  <input name="term" value="<%= t.term %>" required>
                  <textarea name="meaning" required><%= t.meaning %></textarea>
                  <button type="submit" class="btn small">Update</button>
                </form>

                <form
                  action="/dictionary/<%= t.id %>/delete"
                  method="POST"
                  onsubmit="return confirm('Are you sure you want to delete this meaning?');"
                >
                  <button type="submit" class="btn danger small">Delete</button>
                </form>
          </div>
        <% } %>
      </article>
    <% }) %>
  </section>

  <P>
<form action="/dashboard" method="get">
  <button type="submit" class="btn">Back to Homepage</button>
  </form>
  </P>

</main>

<!-- LIVE SEARCH SCRIPT -->
<script>
  const input = document.getElementById("search");
  const resultsBox = document.getElementById("liveResults");
  let timer;

  input.addEventListener("input", () => {
    clearTimeout(timer);
    const q = input.value.trim();
    if (!q) return resultsBox.innerHTML = "";

    timer = setTimeout(async () => {
      const res = await fetch("/dictionary/live?q=" + encodeURIComponent(q));
      const data = await res.json();
      resultsBox.innerHTML = data.map(d => `<li><strong>${d.term}</strong></li>`).join("");
    }, 300);
  });

  function toggleAdmin(id) {
  const el = document.getElementById("admin-" + id);

  // If already open, do nothing (allow delete/update clicks)
  if (el.style.display === "block") return;

  // Close others
  document.querySelectorAll(".admin-controls").forEach(d => {
    d.style.display = "none";
  });

  // Open selected
  el.style.display = "block";
}
</script>

<form action="/dashboard" method="get">
  <button type="submit" class="btn">Back to Homepage</button>
</body>

</body>
<%- include("includes/footer") %>
</html>
