<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <%- include('includes/head') %>
  <link rel="stylesheet" href="/style.css">
</head>

<body>
<%- include('includes/header') %>

<div class="chat-layout">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2>Inbox</h2>
    <h3>Online Users</h3>
    <ul id="online-users-list"></ul>
  </div>
  <!-- END SIDEBAR -->

  <!-- MAIN CHAT AREA -->
  <div class="chat-area">

    <h2>Conversations</h2>
    <ul id="inbox-list" class="conversation-list">
      <% (conversations || []).forEach(c => { %>
        <li class="bubble them" data-user-id="<%= c.id %>">
          <a href="/chat/<%= c.id %>">
            <strong><%= c.username %></strong>
            <span class="unread-badge" style="display:none;">0</span><br>
            <span class="last-message">
              <%= c.lastMessage || "No messages yet" %>
            </span>
          </a>
        </li>
      <% }) %>
    </ul>

    <!-- SEND MESSAGE -->
    <form class="send-box" action="/inbox" method="POST">
      <select name="receiverId" required>
        <option value="">Select user</option>
        <% users.forEach(u => { %>
          <option value="<%= u.id %>"><%= u.username %></option>
        <% }) %>
      </select>

      <textarea
        name="message"
        rows="2"
        placeholder="Type a message..."
        required></textarea>

      <button class="btn">Send</button>
    </form>

  </div>
  <!-- END CHAT AREA -->

</div>

<!-- Sound -->
<audio id="notif-sound" src="/sounds/message.mp3" preload="auto"></audio>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<script>
(function () {
  const currentUserId = <%= JSON.stringify(user.id) %>;
  const allUsers = <%- JSON.stringify(users) %>;
  const socket = io();

  /* =========================
     SOCKET JOIN
  ========================= */
  socket.on("connect", () => {
    socket.emit("join_room", currentUserId);
  });

  /* =========================
     ONLINE USERS
  ========================= */
  function renderOnlineUsers(list) {
    const ul = document.getElementById("online-users-list");
    ul.innerHTML = "";

    list.forEach(userObj => {
      const user = allUsers.find(u => String(u.id) === String(userObj.id));
      if (!user) return;

      const d = new Date(userObj.lastSeen);
      const diffMinutes = (Date.now() - d) / 60000;

      const displayText =
        diffMinutes <= 5
          ? "Active now"
          : `${d.getHours().toString().padStart(2, "0")}:${d
              .getMinutes()
              .toString()
              .padStart(2, "0")}`;

      ul.innerHTML += `
        <li class="user-item">
          <a href="/chat/${user.id}">
            <span class="online-dot"></span>
            ${user.username}
            <small>: ${displayText}</small>
          </a>
        </li>
      `;
    });
  }

  socket.on("online_users", renderOnlineUsers);

  /* =========================
     NOTIFICATIONS â†’ INBOX
  ========================= */
  socket.on("notification", data => {
    if (Number(data.fromId) === Number(currentUserId)) return;
    updateInboxConversation(data);
    playSound();
    vibrate();
    pushNotify(data);
  });

  function updateInboxConversation(data) {
    const ul = document.getElementById("inbox-list");
    let li = ul.querySelector(`[data-user-id="${data.fromId}"]`);

    if (li) {
      const badge = li.querySelector(".unread-badge");
      const count = Number(badge.textContent) + 1;

      badge.textContent = count;
      badge.style.display = "inline-block";

      li.querySelector(".last-message").textContent = data.preview;
      ul.prepend(li);
    } else {
      const newLi = document.createElement("li");
      newLi.className = "bubble them";
      newLi.dataset.userId = data.fromId;
      newLi.innerHTML = `
        <a href="/chat/${data.fromId}">
          <strong>${data.fromName}</strong>
          <span class="unread-badge">1</span><br>
          <span class="last-message">${data.preview}</span>
        </a>
      `;
      ul.prepend(newLi);
    }
  }

  /* =========================
     SOUND
  ========================= */
  function playSound() {
    document.getElementById("notif-sound")?.play().catch(() => {});
  }

  /* =========================
     VIBRATION
  ========================= */
  function vibrate() {
    if (navigator.vibrate) {
      navigator.vibrate([200, 100, 200]);
    }
  }

  /* =========================
     PUSH NOTIFICATIONS
  ========================= */
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  function pushNotify(data) {
    if (Notification.permission === "granted") {
      new Notification(`New message from ${data.fromName}`, {
        body: data.preview,
        icon: "/logo.png"
      });
    }
  }

})();
</script>
<P>
<form action="/dashboard" method="get">
  <button type="submit" class="btn">Back to Homepage</button>
  </form>
  </P>
</body>
<%- include('includes/footer', { user }) %>
</html>
