<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('includes/head') %>
    <link rel="stylesheet" href="/style.css">
</head>

<body>
<%- include('includes/header', { user, notifications: notifications || [] }) %>

<div class="chat-layout">

    <!-- SIDEBAR -->
    <div class="sidebar">
        <h2>Inbox</h2>

        <h3>Online Users</h3>
        <ul id="online-users-list" class="user-list"></ul>

        <h3>All Users</h3>
        <% users.forEach(u => { %>
            <div class="user-item">
                <a href="/chat/<%= u.id %>"><%= u.username %></a>
            </div>
        <% }) %>
    </div>

    <!-- MAIN CHAT AREA -->
    <div class="chat-area">

        <h2>Conversations</h2>
        <ul id="inbox-list" class="conversation-list">
            <% (conversations || []).forEach(c => { %>
                <li class="bubble them">
                    <a href="/chat/<%= c.id %>">
                        <strong><%= c.username %></strong><br>
                        <%= c.lastMessage || "No messages yet" %>
                    </a>
                </li>
            <% }) %>
        </ul>

        <h2>Notifications</h2>
        <div id="notifications-wrapper">
            <a href="/notifications">
                Notifications <span id="notif-badge"><%= unreadCount %></span>
            </a>
            <ul id="notifications-list"></ul>
        </div>

        <hr>

        <!-- SEND MESSAGE -->
        <form class="send-box" action="/inbox" method="POST">
            <select name="receiverId" required>
                <option value="">Select user</option>
                <% users.forEach(u => { %>
                    <option value="<%= u.id %>"><%= u.username %></option>
                <% }) %>
            </select>

            <textarea name="message" rows="2" placeholder="Type a message..." required></textarea>
            <button type="submit">Send</button>
        </form>

    </div>
</div>

<!-- Socket.IO client -->
<script src="/socket.io/socket.io.js"></script>
<script>
(function () {
  const currentUserId = <%= JSON.stringify(user.id) %>;
  const allUsers      = <%- JSON.stringify(users) %>;

  const socket = io();

  socket.on("connect", () => {
    socket.emit("join_room", currentUserId);
  });

  // Render online users
  function renderOnlineUsers(list) {
    const ul = document.getElementById("online-users-list");
    ul.innerHTML = "";

    list.forEach(userObj => {
      const user = allUsers.find(u => String(u.id) === String(userObj.id));
      if (!user) return;

      ul.innerHTML += `
        <li class="user-item">
          <a href="/chat/${user.id}">
            <span class="online-dot"></span> ${user.username}
            <small>Last seen: ${userObj.lastSeen}</small>
          </a>
        </li>
      `;
    });
  }

  socket.on("online_users", renderOnlineUsers);

  // Notifications
  function incBadge() {
    const badge = document.getElementById("notif-badge");
    badge.textContent = Number(badge.textContent) + 1;
  }

  function prependNotification(data) {
    const ul = document.getElementById("notifications-list");
    ul.innerHTML = `
      <li class="bubble them">
        <strong>${data.fromName}</strong> â€” ${data.preview}
      </li>
    ` + ul.innerHTML;
  }

  socket.on("notification", data => {
    incBadge();
    prependNotification(data);
  });
})();
</script>

<%- include('includes/footer', { user }) %>
</body>
</html>
