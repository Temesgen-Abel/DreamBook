<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat with <%= otherUser.username %></title>
  <link rel="stylesheet" href="/style.css">
  <%- include('includes/head') %>
</head>

<body>

<%- include('includes/header') %>

<main>

  <h1>Chat with <%= otherUser.username %></h1>

  <ul class="chat-messages" id="chat-list">
    <% if (messages.length === 0) { %>
      <li>No messages yet. Start the conversation!</li>
    <% } else { %>
      <% messages.forEach(m => { %>
        <li class="chat-message" data-message-id="<%= m.id %>">
          <strong><%= m.sendername %>:</strong>
          <div class="body"><%- m.message %></div>
          <small><%= m.createdAt %></small>
        </li>
      <% }) %>
    <% } %>
  </ul>

  <div id="typing-indicator" style="display:none;margin-top:10px;">
    <%= otherUser.username %> is typing...
  </div>

  <hr>

  <form action="/chat/<%= otherUser.id %>/send" method="POST" id="msgForm">
    <input type="text" 
           name="message" 
           required 
           id="messageInput" 
           placeholder="Type your message...">
    <button type="submit">Send</button>
  </form>

</main>

<script src="/socket.io/socket.io.js"></script>

<script>
const socket = io();
socket.emit("join_room", "<%= user.id %>");

const input = document.getElementById("messageInput");
const form  = document.getElementById("msgForm");

// Send local echo
form.addEventListener("submit", () => {
  socket.emit("send_local_message", {
    senderId: "<%= user.id %>",
    receiverId: "<%= otherUser.id %>",
    message: input.value,
    senderName: "<%= user.username %>"
  });
});

socket.on("new_message", msg => {
  const list = document.getElementById("chat-list");

  const li = document.createElement("li");
  li.className = "chat-message";
  li.innerHTML = `
    <strong>${msg.sendername}:</strong>
    <div class="body">${msg.message}</div>
    <small>${msg.createdAt}</small>
  `;

  list.appendChild(li);
  window.scrollTo(0, document.body.scrollHeight);
});

// TYPING
let typingTimeout;
socket.on("typing", data => {
    if (Number(data.senderId) === Number("<%= otherUser.id %>"))
        document.getElementById("typing-indicator").style.display = "block";
});

socket.on("stop_typing", data => {
    if (Number(data.senderId) === Number("<%= otherUser.id %>"))
        document.getElementById("typing-indicator").style.display = "none";
});

input.addEventListener("input", () => {
    socket.emit("typing", { senderId: '<%= user.id %>', receiverId: '<%= otherUser.id %>' });
    clearTimeout(typingTimeout);

    typingTimeout = setTimeout(() => {
        socket.emit("stop_typing", { senderId: '<%= user.id %>', receiverId: '<%= otherUser.id %>' });
    }, 800);
});
</script>

</body>
</html>
