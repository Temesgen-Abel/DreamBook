<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <meta charset="UTF-8">
  <title>Chat with <%= otherUser.username %></title>
  <link rel="stylesheet" href="/style.css">
  <%- include('includes/head') %>
</head>

<body>

<%- include('includes/header') %>

<div class="chat-layout" style="grid-template-columns: 1fr;"> 

  <!-- CHAT AREA (same style as admin) -->
  <div class="chat-area">

    <h2 style="padding:10px, ">Chat with <%= otherUser.username %></h2>

    <!-- Messages Container -->
    <div class="messages" id="chat-list">

      <% if (messages.length === 0) { %>
        <p>No messages yet. Start the conversation!</p>
      <% } else { %>
        <% messages.forEach(m => { %>

          <div class="bubble <%= m.senderid == user.id ? 'me' : 'them' %>" data-message-id="<%= m.id %>">
            <strong><%= m.sendername %></strong><br>
            <%- m.message %>
            <br>
            <small><%= m.createdAt %></small>
          </div>

        <% }) %>
      <% } %>

    </div>

    <!-- Typing Indicator -->
    <div id="typing-indicator" style="display:none; padding: 5px 10px;">
      <%= otherUser.username %> is typing...
    </div>

    <!-- Send Box (aligned exactly like admin chat) -->
    <form class="send-box" id="msgForm" action="/chat/<%= otherUser.id %>/send" method="POST">
      <textarea 
        name="message" 
        id="messageInput" 
        rows="2" 
        placeholder="Type a message..." 
        required></textarea>
      <button type="submit">Send</button>
    </form>

  </div>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
const socket = io();
socket.emit("join_room", "<%= user.id %>");

const input = document.getElementById("messageInput");
const form  = document.getElementById("msgForm");

// Echo locally
form.addEventListener("submit", () => {
  socket.emit("send_local_message", {
    senderId: "<%= user.id %>",
    receiverId: "<%= otherUser.id %>",
    message: input.value,
    senderName: "<%= user.username %>"
  });
});

// Incoming messages
socket.on("new_message", msg => {
  const container = document.getElementById("chat-list");

  const div = document.createElement("div");
  div.className = `bubble ${msg.senderid == "<%= user.id %>" ? 'me' : 'them'}`;
  div.innerHTML = `
      <strong>${msg.sendername}</strong><br>
      ${msg.message}<br>
      <small>${msg.createdAt}</small>
  `;

  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
});

// TYPING
let typingTimeout;

socket.on("typing", data => {
    if (Number(data.senderId) === Number("<%= otherUser.id %>"))
        document.getElementById("typing-indicator").style.display = "block";
});

socket.on("stop_typing", data => {
    if (Number(data.senderId) === Number("<%= otherUser.id %>"))
        document.getElementById("typing-indicator").style.display = "none";
});

input.addEventListener("input", () => {
    socket.emit("typing", { senderId: '<%= user.id %>', receiverId: '<%= otherUser.id %>' });
    clearTimeout(typingTimeout);

    typingTimeout = setTimeout(() => {
        socket.emit("stop_typing", { senderId: '<%= user.id %>', receiverId: '<%= otherUser.id %>' });
    }, 800);
});
</script>

<form action="/dashboard" method="get">
  <button type="submit" class="btn">Back to Homepage</button>
</body>

</body>
</html>
