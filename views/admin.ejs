<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <%- include('includes/head') %>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
<h1>Admin Dashboard</h1>

<form action="/admin" method="get">
  <button type="submit" class="btn">Refresh Stats</button>
</form>

<% if (typeof visitCount !== "undefined") { %>
  <div class="admin-stat">
    <h4>Total Website Visits</h4>
    <p><%= visitCount %></p>
  </div>
<% } %>

<% if (typeof userCount !== "undefined") { %>
  <div class="admin-stat">
    <h4>Total Registered Users</h4>
    <p><%= userCount %></p>
  </div>

<% } %>
<% if (typeof postCount !== "undefined") { %>
  <div class="admin-stat">
    <h4>Total Dreams Posted</h4>
    <p><%= postCount %></p>
  </div>
<% } %>
<% if (typeof commentCount !== "undefined") { %>
  <div class="admin-stat">
    <h4>Total Comments Made</h4>
    <p><%= commentCount %></p>
  </div>
<% } %>
<% if (typeof activeUsers !== "undefined") { %>
  <div class="admin-stat">
    <h4>Active Users (Last 24 hrs)</h4>
    <p><%= activeUsers %></p>
  </div>
<% } %>
<% if (typeof postsLastWeek !== "undefined") { %>
  <div class="admin-stat">
    <h4>Dreams Posted (Last 7 days)</h4>
    <p><%= postsLastWeek %></p>
  </div>
<% } %>
<% if (typeof commentsLastWeek !== "undefined") { %>
  <div class="admin-stat">
    <h4>Comments Made (Last 7 days)</h4>
    <p><%= commentsLastWeek %></p>
  </div>
<% } %>
<% if (typeof mostActiveUser !== "undefined") { %>
  <div class="admin-stat">
    <h4>Most Active User (Last 7 days)</h4>
    <p><%= mostActiveUser.username %> (<%= mostActiveUser.activityCount %> actions)</p>
  </div>
<% } %>
<% if (typeof mostPostedDreamsUser !== "undefined") { %>
  <div class="admin-stat">
    <h4>User with Most Dreams Posted</h4>
    <p><%= mostPostedDreamsUser.username %> (<%= mostPostedDreamsUser.postCount %> dreams)</p>
  </div>
<% } %>
<% if (typeof mostCommentedUser !== "undefined") { %>
  <div class="admin-stat">
    <h4>User with Most Comments Made</h4>
    <p><%= mostCommentedUser.username %> (<%= mostCommentedUser.commentCount %> comments)</p>
  </div>

<% } %>
<% if (typeof latestUsers !== "undefined" && latestUsers.length) { %>
  <div class="admin-stat">
    <h4>Latest Registered Users</h4>
    <ul>
      <% latestUsers.forEach(user => { %>
        <li><%= user.username %> (Joined: <%= new Date(user.createdAt).toLocaleDateString() %>)</li>
      <% }) %>
    </ul>
  </div>
<% } %>
<% if (typeof latestPosts !== "undefined" && latestPosts.length) { %>
  <div class="admin-stat">
    <h4>Latest Dreams Posted</h4>
    <ul>
      <% latestPosts.forEach(post => { %>
        <li><%= post.username %>: "<%= post.body.length > 30 ? post.body.substring(0, 30) + '...' : post.body
  %>" (Posted: <%= new Date(post.createdDate).toLocaleDateString() %>)</li>
      <% }) %>
    </ul>
  </div>
<% } %>
<% if (typeof latestComments !== "undefined" && latestComments.length) { %>
  <div class="admin-stat">
    <h4>Latest Comments Made</h4>
    <ul>
      <% latestComments.forEach(comment => { %>
        <li><%= comment.authorUsername %>: "<%= comment.body.length > 30 ? comment.body.substring(0, 30) + '...' : comment.body
  %>" (Commented: <%= new Date(comment.createdDate).toLocaleDateString() %>)</li>
      <% }) %>
    </ul>
  </div>
<% } %>


 <% if (typeof users !== "undefined" && users.length) { %>
  <div class="admin-stat">
    <h2>User Role Management</h2>

    <table border="1" style="width:100%; text-align:center;">
      <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Role</th>
        <th>Action</th>
      </tr>

      <% users.forEach(user => { %>
        <tr>
          <td><%= user.id %></td>
          <td><%= user.username %></td>
          <td><%= user.email %></td>
          <td>
            <% if (user.role === "admin") { %>
              <span style="color:red;"><strong>ADMIN</strong></span>
            <% } else if (user.role === "counselor") { %>
              <span style="color:green;">Counselor</span>
            <% } else { %>
              <span>User</span>
            <% } %>
          </td>

          <td>
            <% if (user.role === "user") { %>
              <form action="/admin/promote/<%= user.id %>" method="POST" style="display:inline;">
                <button class="btn">Make Counselor</button>
              </form>
            <% } %>

            <% if (user.role === "counselor") { %>
              <form action="/admin/demote/<%= user.id %>" method="POST" style="display:inline;">
                <button class="btn">Remove Counselor</button>
              </form>
            <% } %>

            <% if (user.role !== "admin") { %>
              <form action="/admin/delete/<%= user.id %>" method="POST" style="display:inline;">
                <button class="btn" style="background:red;">Delete</button>
              </form>
            <% } %>

          </td>
        </tr>
      <% }) %>
    </table>
  </div>
<% } %>


<form action="/dashboard" method="get">
  <button type="submit" class="btn">Back to Homepage</button>
</form>

</body>

</html


