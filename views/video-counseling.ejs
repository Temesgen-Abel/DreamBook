<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <%- include('includes/head') %>
  <link rel="stylesheet" href="/style.css">
  <style>
    .dashboard-section {
      margin-bottom: 30px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .dashboard-section h2 {
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .buttons {
      display: flex;
      gap: 10px;
    }

    /* meeting controls toolbar */
    #meetingControls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    #meetingControls .btn {
      min-width: 80px;
    }

    /* position controls over video container */
    .video-controls {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 8px;
      z-index: 10;
    }

    .videos {
      position: relative; /* for overlay */
    }

    .videos {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }

    video {
      width: 300px;
      background: #000;
      border-radius: 10px;
    }

    .documents {
      margin-top: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .document-card {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 200px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
  </style>
</head>
<body>
  <%- include("includes/header") %>

  <div class="container">

    <% if (meeting && meeting.id) { %>
      <!-- meeting view -->
      <div class="alert alert-info mt-3">
        <strong>Meeting ID:</strong> <code><%= meeting.id %></code><br>
        <strong>Share link:</strong>
        <a href="<%= meeting.meeting_link %>" target="_blank">
          <%= meeting.meeting_link %>
        </a>
        <button class="btn btn-sm btn-outline-secondary ml-2" onclick="copyLink()">Copy</button>
      </div>
      <script>
        function copyLink() {
          navigator.clipboard.writeText("<%= meeting.meeting_link %>");
          alert('Link copied to clipboard');
        }
      </script>

      <section id="meeting-room" class="dashboard-section">
        <h2>ðŸŸ  In Meeting: <%= meeting.title || 'Untitled' %></h2>
        <% if (isHost) { %>
          <button id="endMeetingBtn" class="btn btn-danger mb-2">End Meeting</button>
          <p class="text-muted">Share the link above with participants.</p>
        <% } else { %>
          <p class="text-muted">You are in the meeting; others may join shortly.</p>
        <% } %>
        <!-- camera control available to all attendees -->
        <button id="startCamBtn" class="btn btn-secondary mb-2">Start Camera</button>

        <div class="videos" id="group-video-container">
          <!-- meeting controls overlay -->
          <div id="meetingControls" class="video-controls">
            <button id="toggleAudioBtn" class="btn btn-outline-primary">Mute</button>
            <button id="toggleVideoBtn" class="btn btn-outline-primary">Stop Video</button>
            <button id="leaveBtn" class="btn btn-outline-danger">Leave</button>
          </div>
          <!-- video elements injected here -->
        </div>

        <div id="waitingList" class="mt-3">
          <h4>Participants</h4>
          <ul id="waitingUsers"></ul>
          <p id="noWaiting" class="text-muted">No one else is here yet.</p>
        </div>
      </section>

    <% } else { %>
      <!-- dashboard content -->

      <!-- ================= Group Meetings ================= -->
      <div class="dashboard-section" id="group-meetings">
        <h2>
          ðŸ”µ Live Group Meetings
          <div class="buttons">
            <a href="/live-meetings/create" class="btn btn-primary">Create Session</a>
            <a href="/live-meetings/join" class="btn btn-success">Join Session</a>
          </div>
        </h2>

        <div class="videos" id="group-video-container">
          <!-- Live group meeting video streams inserted here via Socket.IO -->
        </div>

        <div class="documents">
          <% if(groupDocuments && groupDocuments.length) { %>
            <% groupDocuments.forEach(doc => { %>
              <div class="document-card">
                <strong><%= doc.name %></strong>
                <div>
                  <a href="<%= doc.url %>" target="_blank" class="btn btn-sm btn-outline-primary">View</a>
                  <% if(isAdmin) { %>
                    <a href="/documents/<%= doc.id %>/edit" class="btn btn-sm btn-outline-warning">Edit</a>
                    <a href="/documents/<%= doc.id %>/download" class="btn btn-sm btn-outline-success">Download</a>
                  <% } %>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p>No documents yet.</p>
          <% } %>
        </div>
      </div>

      <!-- ================= 1-to-1 Counseling ================= -->
      <div class="dashboard-section" id="one-to-one-counseling">
        <h2>
          ðŸŸ¢ 1-to-1 Counseling
          <div class="buttons">
            <a href="/create-counseling-session" class="btn btn-primary">Schedule Session</a>
            <a href="/join-counseling-session" class="btn btn-success">Join Session</a>
          </div>
        </h2>

        <div class="videos" id="counseling-video-container">
          <!-- 1-to-1 video streams inserted here via Socket.IO -->
        </div>

        <div class="documents">
          <% if(counselingDocuments && counselingDocuments.length) { %>
            <% counselingDocuments.forEach(doc => { %>
              <div class="document-card">
                <strong><%= doc.name %></strong>
                <div>
                  <a href="<%= doc.url %>" target="_blank" class="btn btn-sm btn-outline-primary">View</a>
                  <% if(isAdmin) { %>
                    <a href="/documents/<%= doc.id %>/edit" class="btn btn-sm btn-outline-warning">Edit</a>
                    <a href="/documents/<%= doc.id %>/download" class="btn btn-sm btn-outline-success">Download</a>
                  <% } %>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p>No documents yet.</p>
          <% } %>
        </div>
      </div>

    <% } %>

  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // when we have meeting information, immediately join on connect
    <% if (meeting && meeting.id) { %>
      socket.emit('join_meeting', {
        meetingId: '<%= meeting.id %>',
        userId: '<%= userId %>'
      });
    <% } %>

    // handle local media and peer connections
    let localStream = null;
    const pcs = {}; // map socketId -> RTCPeerConnection
    const seenParticipants = new Set(); // prevent duplicate UI entries
    let audioEnabled = true;
    let videoEnabled = true;

    async function startLocalStream() {
      if (localStream) return localStream;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        const vid = document.createElement('video');
        vid.autoplay = true;
        vid.muted = true; // prevent echo
        vid.srcObject = localStream;
        document.getElementById('group-video-container').appendChild(vid);
        if (startCamBtn) startCamBtn.style.display = 'none';
        // add tracks to existing peer connections and renegotiate
        Object.entries(pcs).forEach(async ([remoteId, pc]) => {
          localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
          try {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit('webrtc_offer', { to: remoteId, sdp: offer, from: socket.id });
          } catch (e) {
            console.error('renegotiation failed', e);
          }
        });
        return localStream;
      } catch (err) {
        console.error('failed to get media', err);
        alert('Could not access camera/microphone');
      }
    }

    const startCamBtn = document.getElementById('startCamBtn');
    if (startCamBtn) {
      startCamBtn.addEventListener('click', startLocalStream);
    }

    // control buttons
    const toggleAudioBtn = document.getElementById('toggleAudioBtn');
    const toggleVideoBtn = document.getElementById('toggleVideoBtn');
    const leaveBtn = document.getElementById('leaveBtn');

    function updateControlLabels() {
      if (toggleAudioBtn) toggleAudioBtn.textContent = audioEnabled ? 'Mute' : 'Unmute';
      if (toggleVideoBtn) toggleVideoBtn.textContent = videoEnabled ? 'Stop Video' : 'Start Video';
    }

    if (toggleAudioBtn) {
      toggleAudioBtn.addEventListener('click', () => {
        if (!localStream) return;
        audioEnabled = !audioEnabled;
        localStream.getAudioTracks().forEach(t => t.enabled = audioEnabled);
        updateControlLabels();
      });
    }
    if (toggleVideoBtn) {
      toggleVideoBtn.addEventListener('click', () => {
        if (!localStream) return;
        videoEnabled = !videoEnabled;
        localStream.getVideoTracks().forEach(t => t.enabled = videoEnabled);
        updateControlLabels();
      });
    }
    if (leaveBtn) {
      leaveBtn.addEventListener('click', () => {
        socket.disconnect();
        window.location.href = '/dashboard';
      });
    }

    updateControlLabels();

    // automatically start local stream when joining meeting
    <% if (meeting && meeting.id) { %>
      startLocalStream();
    <% } %>

    // utility to create new RTCPeerConnection for a socket
    function createPeerConnection(remoteSocketId) {
      const pc = new RTCPeerConnection();
      pc.onicecandidate = e => {
        if (e.candidate) {
          socket.emit('webrtc_ice_candidate', {
            to: remoteSocketId,
            candidate: e.candidate,
            from: socket.id
          });
        }
      };
      pc.ontrack = e => {
        const vid = document.createElement('video');
        vid.autoplay = true;
        vid.playsInline = true;
        vid.srcObject = e.streams[0];
        document.getElementById('group-video-container').appendChild(vid);
      };
      // attach local tracks once available
      if (localStream) {
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      } else {
        // if not ready yet, wait
        startLocalStream().then(s => s.getTracks().forEach(track => pc.addTrack(track, s)));
      }
      pcs[remoteSocketId] = pc;
      return pc;
    }

    socket.on('participant_joined', async data => {
      console.log('participant joined', data);
      // avoid adding duplicate entries
      if (seenParticipants.has(data.socketId)) return;
      seenParticipants.add(data.socketId);
      // update visible participant list
      const ul = document.getElementById('waitingUsers');
      if (ul) {
        const li = document.createElement('li');
        li.textContent = data.userId;
        ul.appendChild(li);
        const noWaiting = document.getElementById('noWaiting');
        if (noWaiting) noWaiting.style.display = 'none';
      }

      if (data.socketId === socket.id) return; // ignore self when negotiating
      const pc = createPeerConnection(data.socketId);
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit('webrtc_offer', { to: data.socketId, sdp: offer, from: socket.id });
    });

    socket.on('webrtc_offer', async ({ from, sdp }) => {
      const pc = createPeerConnection(from);
      await pc.setRemoteDescription(new RTCSessionDescription(sdp));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit('webrtc_answer', { to: from, sdp: answer, from: socket.id });
    });

    socket.on('webrtc_answer', async ({ from, sdp }) => {
      const pc = pcs[from];
      if (pc) {
        await pc.setRemoteDescription(new RTCSessionDescription(sdp));
      }
    });

    socket.on('webrtc_ice_candidate', ({ from, candidate }) => {
      const pc = pcs[from];
      if (pc) {
        pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(console.error);
      }
    });

    // host_ready event means the server acknowledged the host join
    socket.on('host_ready', () => {
      console.log('host connected, meeting marked live');
      const info = document.createElement('div');
      info.className = 'alert alert-info';
      info.textContent = 'You are hosting this meeting. Waiting for participants...';
      document.querySelector('.container').prepend(info);
    });

    <% if (meeting && meeting.id) { %>
    // waiting user notification (host sees new users)
    socket.on('waiting_user', data => {
      console.log('new user waiting', data);
      const noWaiting = document.getElementById('noWaiting');
      if (noWaiting) noWaiting.style.display = 'none';
      <% if (isHost) { %>
        const ul = document.getElementById('waitingUsers');
        if (ul) {
          const li = document.createElement('li');
          li.textContent = `User ${data.userId}`;
          const approve = document.createElement('button');
          approve.textContent = 'âœ…';
          approve.className = 'btn btn-sm btn-success ml-1';
          approve.onclick = () => {
            socket.emit('approve_user', { meetingId: '<%= meeting.id %>', userId: data.userId });
            li.remove();
          };
          const reject = document.createElement('button');
          reject.textContent = 'âŒ';
          reject.className = 'btn btn-sm btn-danger ml-1';
          reject.onclick = () => {
            socket.emit('reject_user', { meetingId: '<%= meeting.id %>', userId: data.userId });
            li.remove();
          };
          li.appendChild(approve);
          li.appendChild(reject);
          ul.appendChild(li);
        }
      <% } %>
    });

    // participant approved/joined
    socket.on('approved', () => {
      console.log('you have been approved to join the meeting');
      // hide waiting message if present
      const wt = document.getElementById('waitingText');
      if (wt) wt.remove();
    });
    socket.on('participant_joined', data => {
      console.log('participant joined', data);
    });

    // participant rejected
    socket.on('rejected', () => {
      alert('Your request to join was rejected by the host');
      window.location.href = '/dashboard';
    });

    // host can end the meeting
    const endBtn = document.getElementById('endMeetingBtn');
    if (endBtn) {
      endBtn.addEventListener('click', () => {
        if (confirm('End this meeting for everyone?')) {
          socket.emit('end_meeting', { meetingId: '<%= meeting ? meeting.id : '' %>' });
        }
      });
    }

    socket.on('meeting_ended', () => {
      alert('Meeting has been ended by the host');
      window.location.href = '/dashboard';
    });
    <% } %>

    // ================= Group Meeting Videos =================
    const groupContainer = document.getElementById('group-video-container');
    socket.on('group-video-update', participants => {
      groupContainer.innerHTML = '';
      participants.forEach(p => {
        const vid = document.createElement('video');
        vid.srcObject = p.stream; // Assumes stream is sent via WebRTC
        vid.autoplay = true;
        vid.playsInline = true;
        groupContainer.appendChild(vid);
      });
    });

    // ================= 1-to-1 Counseling Videos =================
    const counselingContainer = document.getElementById('counseling-video-container');
    socket.on('counseling-video-update', participants => {
      counselingContainer.innerHTML = '';
      participants.forEach(p => {
        const vid = document.createElement('video');
        vid.srcObject = p.stream;
        vid.autoplay = true;
        vid.playsInline = true;
        counselingContainer.appendChild(vid);
      });
    });
  </script>
</body>
</html>