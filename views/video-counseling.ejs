<!DOCTYPE html>
<html>
<head>
  <title>Live Meeting</title>
  <style>
    .videos { display:flex; flex-wrap:wrap; gap:10px; }
    video { width:300px; background:black; border-radius:8px; }
    textarea { width:100%; height:200px; }
    .btn { padding:8px 14px; margin:5px; cursor:pointer; }
  </style>
</head>
<body>

<h2><%= meeting.title %></h2>

<div class="videos" id="videoContainer">
  <video id="localVideo" autoplay muted playsinline></video>
</div>

<button id="muteSelf" class="btn">Mute Myself</button>

<% if (isHost) { %>
<button id="muteAll" class="btn">Mute All</button>
<button id="endMeeting" class="btn">End Meeting</button>
<% } %>

<h3>Shared Document</h3>
<textarea id="sharedDoc"><%= meeting.description || "" %></textarea>
<button id="saveDoc" class="btn">Save</button>

<script src="/socket.io/socket.io.js"></script>
<script>

const socket = io();
const meetingId = "<%= meeting.id %>";
const userId = Number("<%= userId %>");
const isHost = <%= isHost ? "true" : "false" %>;

let localStream;
let peers = {};

const container = document.getElementById("videoContainer");

async function initMedia() {
  localStream = await navigator.mediaDevices.getUserMedia({
    video:true,
    audio:true
  });
  document.getElementById("localVideo").srcObject = localStream;
}

socket.emit("join_meeting", { meetingId, userId });

socket.on("approved", async () => {
  await initMedia();
});

socket.on("host_ready", async () => {
  await initMedia();
});

socket.on("participant_joined", async ({ socketId }) => {

  const peer = new RTCPeerConnection();
  peers[socketId] = peer;

  localStream.getTracks().forEach(track=>{
    peer.addTrack(track, localStream);
  });

  peer.ontrack = e => {
    const video = document.createElement("video");
    video.autoplay = true;
    video.srcObject = e.streams[0];
    container.appendChild(video);
  };

  peer.onicecandidate = e=>{
    if(e.candidate){
      socket.emit("webrtc_ice_candidate", {
        to: socketId,
        candidate: e.candidate
      });
    }
  };

  const offer = await peer.createOffer();
  await peer.setLocalDescription(offer);

  socket.emit("webrtc_offer", {
    to: socketId,
    offer
  });
});

socket.on("webrtc_offer", async data => {

  const peer = new RTCPeerConnection();
  peers[data.from] = peer;

  localStream.getTracks().forEach(track=>{
    peer.addTrack(track, localStream);
  });

  peer.ontrack = e=>{
    const video = document.createElement("video");
    video.autoplay = true;
    video.srcObject = e.streams[0];
    container.appendChild(video);
  };

  await peer.setRemoteDescription(
    new RTCSessionDescription(data.offer)
  );

  const answer = await peer.createAnswer();
  await peer.setLocalDescription(answer);

  socket.emit("webrtc_answer", {
    to: data.from,
    answer
  });
});

socket.on("webrtc_answer", async data => {
  await peers[data.from]
    .setRemoteDescription(new RTCSessionDescription(data.answer));
});

socket.on("webrtc_ice_candidate", async data => {
  await peers[data.from]
    .addIceCandidate(new RTCIceCandidate(data.candidate));
});

document.getElementById("muteSelf").onclick = ()=>{
  localStream.getAudioTracks()
    .forEach(t=> t.enabled = !t.enabled);
};

if(isHost){
  document.getElementById("muteAll").onclick = ()=>{
    socket.emit("mute_all", { meetingId });
  };
  document.getElementById("endMeeting").onclick = ()=>{
    socket.emit("end_meeting", { meetingId });
  };
}

socket.on("muted_by_host", ()=>{
  localStream.getAudioTracks().forEach(t=> t.enabled=false);
  alert("You were muted");
});

socket.on("meeting_ended", ()=>{
  alert("Meeting ended");
  window.location.href="/video-counseling";
});

// =======================
// DOCUMENT COLLAB
// =======================

const textarea = document.getElementById("sharedDoc");

textarea.addEventListener("input", ()=>{
  socket.emit("doc_change", {
    meetingId,
    content: textarea.value
  });
});

socket.on("doc_change", content=>{
  textarea.value = content;
});

document.getElementById("saveDoc").onclick = ()=>{
  socket.emit("save_document", {
    meetingId,
    content: textarea.value
  });
  alert("Saved");
};

</script>
</body>
</html>