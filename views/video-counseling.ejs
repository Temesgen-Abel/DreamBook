<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <%- include('includes/head') %>
  <link rel="stylesheet" href="/style.css">
  <style>
    .dashboard-section {
      margin-bottom: 30px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .dashboard-section h2 {
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .buttons {
      display: flex;
      gap: 10px;
    }

    .videos {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }

    video {
      width: 300px;
      background: #000;
      border-radius: 10px;
    }

    .documents {
      margin-top: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .document-card {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 200px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
  </style>
</head>
<body>
  <%- include("includes/header") %>

  <div class="container">

    <% if (meeting && meeting.id) { %>
      <!-- meeting view -->
      <div class="alert alert-info mt-3">
        <strong>Meeting ID:</strong> <code><%= meeting.id %></code><br>
        <strong>Share link:</strong>
        <a href="<%= meeting.meeting_link %>" target="_blank">
          <%= meeting.meeting_link %>
        </a>
        <button class="btn btn-sm btn-outline-secondary ml-2" onclick="copyLink()">Copy</button>
      </div>
      <script>
        function copyLink() {
          navigator.clipboard.writeText("<%= meeting.meeting_link %>");
          alert('Link copied to clipboard');
        }
      </script>

      <section id="meeting-room" class="dashboard-section">
        <h2>ðŸŸ  In Meeting: <%= meeting.title || 'Untitled' %></h2>
        <% if (isHost) { %>
          <button id="endMeetingBtn" class="btn btn-danger mb-2">End Meeting</button>
        <% } %>

        <div class="videos" id="group-video-container">
          <!-- video elements injected here -->
        </div>

        <% if (isHost) { %>
          <div id="waitingList" class="mt-3">
            <h4>Waiting users</h4>
            <ul id="waitingUsers"></ul>
          </div>
        <% } else { %>
          <p id="waitingText" class="text-muted">Waiting for host approvalâ€¦</p>
        <% } %>
      </section>

    <% } else { %>
      <!-- dashboard content -->

      <!-- ================= Group Meetings ================= -->
      <div class="dashboard-section" id="group-meetings">
        <h2>
          ðŸ”µ Live Group Meetings
          <div class="buttons">
            <a href="/live-meetings/create" class="btn btn-primary">Create Session</a>
            <a href="/live-meetings/join" class="btn btn-success">Join Session</a>
          </div>
        </h2>

        <div class="videos" id="group-video-container">
          <!-- Live group meeting video streams inserted here via Socket.IO -->
        </div>

        <div class="documents">
          <% if(groupDocuments && groupDocuments.length) { %>
            <% groupDocuments.forEach(doc => { %>
              <div class="document-card">
                <strong><%= doc.name %></strong>
                <div>
                  <a href="<%= doc.url %>" target="_blank" class="btn btn-sm btn-outline-primary">View</a>
                  <% if(isAdmin) { %>
                    <a href="/documents/<%= doc.id %>/edit" class="btn btn-sm btn-outline-warning">Edit</a>
                    <a href="/documents/<%= doc.id %>/download" class="btn btn-sm btn-outline-success">Download</a>
                  <% } %>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p>No documents yet.</p>
          <% } %>
        </div>
      </div>

      <!-- ================= 1-to-1 Counseling ================= -->
      <div class="dashboard-section" id="one-to-one-counseling">
        <h2>
          ðŸŸ¢ 1-to-1 Counseling
          <div class="buttons">
            <a href="/create-counseling-session" class="btn btn-primary">Schedule Session</a>
            <a href="/join-counseling-session" class="btn btn-success">Join Session</a>
          </div>
        </h2>

        <div class="videos" id="counseling-video-container">
          <!-- 1-to-1 video streams inserted here via Socket.IO -->
        </div>

        <div class="documents">
          <% if(counselingDocuments && counselingDocuments.length) { %>
            <% counselingDocuments.forEach(doc => { %>
              <div class="document-card">
                <strong><%= doc.name %></strong>
                <div>
                  <a href="<%= doc.url %>" target="_blank" class="btn btn-sm btn-outline-primary">View</a>
                  <% if(isAdmin) { %>
                    <a href="/documents/<%= doc.id %>/edit" class="btn btn-sm btn-outline-warning">Edit</a>
                    <a href="/documents/<%= doc.id %>/download" class="btn btn-sm btn-outline-success">Download</a>
                  <% } %>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p>No documents yet.</p>
          <% } %>
        </div>
      </div>

    <% } %>

  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // when we have meeting information, immediately join on connect
    <% if (meeting && meeting.id) { %>
      socket.emit('join_meeting', {
        meetingId: '<%= meeting.id %>',
        userId: '<%= userId %>'
      });
    <% } %>

    // host_ready event means the server acknowledged the host join
    socket.on('host_ready', () => {
      console.log('host connected, meeting marked live');
      const info = document.createElement('div');
      info.className = 'alert alert-info';
      info.textContent = 'You are hosting this meeting. Waiting for participants...';
      document.querySelector('.container').prepend(info);
    });

    // waiting user notification (host sees new users)
    socket.on('waiting_user', data => {
      console.log('new user waiting', data);
      <% if (isHost) { %>
        const ul = document.getElementById('waitingUsers');
        if (ul) {
          const li = document.createElement('li');
          li.textContent = `User ${data.userId}`;
          const approve = document.createElement('button');
          approve.textContent = 'âœ…';
          approve.className = 'btn btn-sm btn-success ml-1';
          approve.onclick = () => {
            socket.emit('approve_user', { meetingId: '<%= meeting.id %>', userId: data.userId });
            li.remove();
          };
          const reject = document.createElement('button');
          reject.textContent = 'âŒ';
          reject.className = 'btn btn-sm btn-danger ml-1';
          reject.onclick = () => {
            socket.emit('reject_user', { meetingId: '<%= meeting.id %>', userId: data.userId });
            li.remove();
          };
          li.appendChild(approve);
          li.appendChild(reject);
          ul.appendChild(li);
        }
      <% } %>
    });

    // participant approved/joined
    socket.on('approved', () => {
      console.log('you have been approved to join the meeting');
      // hide waiting message if present
      const wt = document.getElementById('waitingText');
      if (wt) wt.remove();
    });
    socket.on('participant_joined', data => {
      console.log('participant joined', data);
    });

    // participant rejected
    socket.on('rejected', () => {
      alert('Your request to join was rejected by the host');
      window.location.href = '/dashboard';
    });

    // host can end the meeting
    const endBtn = document.getElementById('endMeetingBtn');
    if (endBtn) {
      endBtn.addEventListener('click', () => {
        if (confirm('End this meeting for everyone?')) {
          socket.emit('end_meeting', { meetingId: '<%= meeting ? meeting.id : '' %>' });
        }
      });
    }

    socket.on('meeting_ended', () => {
      alert('Meeting has been ended by the host');
      window.location.href = '/dashboard';
    });

    // ================= Group Meeting Videos =================
    const groupContainer = document.getElementById('group-video-container');
    socket.on('group-video-update', participants => {
      groupContainer.innerHTML = '';
      participants.forEach(p => {
        const vid = document.createElement('video');
        vid.srcObject = p.stream; // Assumes stream is sent via WebRTC
        vid.autoplay = true;
        vid.playsInline = true;
        groupContainer.appendChild(vid);
      });
    });

    // ================= 1-to-1 Counseling Videos =================
    const counselingContainer = document.getElementById('counseling-video-container');
    socket.on('counseling-video-update', participants => {
      counselingContainer.innerHTML = '';
      participants.forEach(p => {
        const vid = document.createElement('video');
        vid.srcObject = p.stream;
        vid.autoplay = true;
        vid.playsInline = true;
        counselingContainer.appendChild(vid);
      });
    });
  </script>
</body>
</html>