<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <%- include('includes/head') %>
  <link rel="stylesheet" href="/style.css">
  <style>
    .dashboard-section { margin-bottom:30px; padding:15px; background:#f8f9fa; border-radius:8px; }
    .videos { display:flex; gap:10px; margin-top:20px; justify-content:center; flex-wrap:wrap; }
    video { width:300px; background:#000; border-radius:10px; }
    .controls { margin-top:15px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .meeting-link { background:#f1f3f5; padding:10px; border-radius:6px; margin-bottom:15px; }
    .meeting-link input { width:100%; padding:5px; }
    #recordBtn { padding:5px 10px; }
    .doc-list { margin-top: 15px; }
    .doc-item { border:1px solid #ccc; padding:5px; margin-bottom:5px; border-radius:4px; display:flex; flex-direction:column; }
    .doc-header { display:flex; justify-content:space-between; align-items:center; }
    .doc-editor { width:100%; height:150px; margin-top:5px; }
    .btn-small { padding:2px 6px; font-size:12px; }
  </style>
</head>
<body>
  <%- include('includes/header') %>

  <div class="chat-layout">
    <div class="video-counseling">
      <h1>Video Counseling Dashboard</h1>

      <% if (meeting) { %>
      <div class="dashboard-section">
        <h3>Documents</h3>
        <form id="uploadDocForm" enctype="multipart/form-data">
          <input type="file" name="document" required>
          <button type="submit" class="btn">Upload</button>
        </form>
        <div class="doc-list" id="docList"></div>
      </div>
      <% } %>

      <% if (roomId || meeting) { %>
        <div class="videos">
          <video id="localVideo" autoplay muted playsinline></video>
        </div>
      <% } %>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const roomId = "<%= roomId || (meeting && meeting.id) %>";
    const userId = "<%= userId %>";
    const isHost = <%= meeting && meeting.created_by === userId ? "true" : "false" %>;

    const docList = document.getElementById("docList");
    let editableDocs = {}; // documentId -> boolean

    async function loadDocuments() {
      const res = await fetch(`/live-meetings/${roomId}/documents`);
      const docs = await res.json();
      docList.innerHTML = "";

      docs.forEach(doc => {
        const canEdit = isHost || doc.can_edit_user_id == userId;
        editableDocs[doc.id] = canEdit;

        const div = document.createElement("div");
        div.className = "doc-item";
        div.id = "doc_"+doc.id;
        div.innerHTML = `
          <div class="doc-header">
            <span>${doc.file_path}</span>
            <div>
              ${isHost ? `<button class="btn-small" onclick="grantEdit(${doc.id})">Grant Edit</button>` : ""}
              <button class="btn-small" onclick="downloadDoc('${doc.id}')">Download</button>
            </div>
          </div>
          <textarea class="doc-editor" id="docEditor_${doc.id}" ${canEdit ? "" : "readonly"}>${doc.content || ""}</textarea>
          ${canEdit ? `<button class="btn-small" onclick="saveDoc(${doc.id})">Save</button>` : ""}
        `;
        docList.appendChild(div);

        const editor = document.getElementById("docEditor_"+doc.id);
        editor.addEventListener("input", ()=>{
          if(editableDocs[doc.id]){
            socket.emit("doc_update", { meetingId: roomId, content: editor.value, documentId: doc.id });
          }
        });
      });
    }

    async function grantEdit(docId){
      const userToEdit = prompt("Enter user ID to allow edit:");
      if(!userToEdit) return;
      await fetch(`/live-meetings/${roomId}/grant-edit`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ documentId: docId, userId: userToEdit })
      });
      socket.emit("refresh_docs", { meetingId: roomId });
    }

    function saveDoc(docId){
      const editor = document.getElementById("docEditor_"+docId);
      fetch(`/live-meetings/${roomId}/edit-doc`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ documentId: docId, content: editor.value })
      });
    }

    function downloadDoc(docId){
      const editor = document.getElementById("docEditor_"+docId);
      const blob = new Blob([editor.value], {type:"text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `document_${docId}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    socket.on("doc_update", ({ content, documentId })=>{
      const editor = document.getElementById("docEditor_"+documentId);
      if(editor) editor.value = content;
    });

    socket.on("refresh_docs", ()=> loadDocuments());

    loadDocuments();

    // DOCUMENT UPLOAD
    const uploadForm = document.getElementById("uploadDocForm");
    uploadForm?.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const formData = new FormData(uploadForm);
      await fetch(`/live-meetings/${roomId}/upload-doc`, {
        method:"POST",
        body: formData
      });
      socket.emit("refresh_docs", { meetingId: roomId });
      uploadForm.reset();
    });
  </script>
</body>
</html>