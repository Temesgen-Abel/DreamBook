<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <%- include('includes/head') %>
  <link rel="stylesheet" href="/style.css">

  <style>
    .videos {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }

    video {
      width: 300px;
      background: #000;
      border-radius: 10px;
    }

    .controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .meeting-link {
      background: #f1f3f5;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
    }

    .meeting-link input {
      width: 100%;
      padding: 5px;
    }
  </style>
</head>

<body>
<%- include('includes/header') %>

<div class="chat-layout">
<div class="video-counseling">

<% if (!roomId && !meeting) { %>

  <!-- ========================= -->
  <!-- SESSION REQUEST PAGE -->
  <!-- ========================= -->

  <% if (users && users.length) { %>
    <form action="/video-counseling" method="POST">
      <select name="counselorId" required>
        <option value="">Select Counselor</option>
        <% users.forEach(u => { %>
          <option value="<%= u.id %>"><%= u.username %></option>
        <% }) %>
      </select>
      <button class="btn">Request Video Session</button>
    </form>
  <% } %>

<% } else { %>

  <h1>Video Counseling</h1>

  <% if (pendingRequests && pendingRequests.length) { %>
    <h3>Pending Requests</h3>
    <% pendingRequests.forEach(req => { %>
      <div class="pending-box">
        <span><strong><%= req.username %></strong> requested a session</span>
        <form action="/video-counseling/accept/<%= req.id %>" method="POST">
          <button class="btn">Accept</button>
        </form>
      </div>
    <% }) %>
  <% } %>

    <!-- ========================= -->
  <!-- CREATE GROUP MEETING -->
  <!-- ========================= -->

  <form action="/live-meetings/create" method="POST" style="margin-bottom: 20px;">
    <input type="text" name="title" placeholder="Meeting Title" required>
    <button class="btn">Create Group Meeting</button>
  </form>
  
  <h1>
    <%= meeting ? meeting.title : "Live Video Counseling" %>
  </h1>

  <!-- Creator sees share link -->
  <% if (meeting && meeting.created_by === userId) { %>
    <div class="meeting-link">
      <p><strong>Share this link:</strong></p>
      <input value="<%= meeting.meeting_link %>" readonly>
    </div>
  <% } %>



  <div class="videos">
    <video id="localVideo" autoplay muted playsinline></video>
  </div>

  <div class="controls">
    <button id="muteBtn">Mute</button>
    <button id="endBtn">End</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const roomId = "<%= roomId || (meeting && meeting.id) %>";
    const userId = "<%= userId %>";
    const isGroup = <%= meeting ? "true" : "false" %>;

    const localVideo = document.getElementById("localVideo");
    const muteBtn = document.getElementById("muteBtn");
    const endBtn = document.getElementById("endBtn");

    let localStream;
    let isMuted = false;

    // Multiple peers (for group)
    const peers = {};

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localStream = stream;
        localVideo.srcObject = stream;

        if (isGroup) {
          socket.emit("join_meeting", { meetingId: roomId, userId });
        } else {
          socket.emit("join_call", { roomId, userId });
        }
      });

    /* =========================
       GROUP MEETING LOGIC
    ========================= */

    if (isGroup) {

      socket.on("user_joined", async (newUserId) => {

        const peer = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });

        peers[newUserId] = peer;

        localStream.getTracks().forEach(track => {
          peer.addTrack(track, localStream);
        });

        peer.ontrack = event => {
          const video = document.createElement("video");
          video.autoplay = true;
          video.playsInline = true;
          video.srcObject = event.streams[0];
          document.querySelector(".videos").appendChild(video);
        };

        peer.onicecandidate = event => {
          if (event.candidate) {
            socket.emit("group_ice_candidate", {
              meetingId: roomId,
              candidate: event.candidate,
              to: newUserId
            });
          }
        };

        const offer = await peer.createOffer();
        await peer.setLocalDescription(offer);

        socket.emit("group_offer", {
          meetingId: roomId,
          offer,
          to: newUserId
        });
      });

    }

    /* =========================
       1-to-1 LOGIC
    ========================= */

    if (!isGroup) {

      const peer = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      localStream?.getTracks().forEach(track => {
        peer.addTrack(track, localStream);
      });

      peer.ontrack = event => {
        const video = document.createElement("video");
        video.autoplay = true;
        video.playsInline = true;
        video.srcObject = event.streams[0];
        document.querySelector(".videos").appendChild(video);
      };

      peer.onicecandidate = event => {
        if (event.candidate) {
          socket.emit("webrtc_ice_candidate", {
            roomId,
            candidate: event.candidate
          });
        }
      };

      socket.on("peer_joined", async () => {
        const offer = await peer.createOffer();
        await peer.setLocalDescription(offer);
        socket.emit("webrtc_offer", { roomId, offer });
      });

      socket.on("webrtc_offer", async ({ offer }) => {
        await peer.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peer.createAnswer();
        await peer.setLocalDescription(answer);
        socket.emit("webrtc_answer", { roomId, answer });
      });

      socket.on("webrtc_answer", async ({ answer }) => {
        await peer.setRemoteDescription(new RTCSessionDescription(answer));
      });

      socket.on("webrtc_ice_candidate", async ({ candidate }) => {
        await peer.addIceCandidate(new RTCIceCandidate(candidate));
      });

    }

    /* =========================
       COMMON CONTROLS
    ========================= */

    muteBtn.addEventListener("click", () => {
      isMuted = !isMuted;
      localStream.getAudioTracks().forEach(track => {
        track.enabled = !isMuted;
      });
      muteBtn.innerText = isMuted ? "Unmute" : "Mute";
    });

    endBtn.addEventListener("click", () => {
      localStream.getTracks().forEach(track => track.stop());
      socket.disconnect();
      window.location.href = "/video-counseling";
    });

  </script>

<% } %>

</div>
</div>
</body>
</html>