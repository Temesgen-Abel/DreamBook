<!DOCTYPE html>
<html lang="<%= lang || 'en' %>">
<head>
<meta charset="UTF-8">

<title>
<% if (meeting) { %>
  <%= meeting.title %>
<% } else if (roomId) { %>
  Video Counseling Session
<% } else { %>
  Video Counseling Dashboard
<% } %>
</title>

<style>
body{font-family:Arial;margin:20px;}
.section{background:#f4f6f9;padding:20px;border-radius:10px;margin-bottom:25px;}
.videos{display:flex;gap:10px;flex-wrap:wrap;margin-top:15px;}
video{width:280px;background:#000;border-radius:10px;}
.btn{padding:8px 14px;margin:5px 5px 5px 0;border:none;border-radius:6px;cursor:pointer;background:#2d89ef;color:#fff;}
.btn.danger{background:#d9534f;}
.btn.secondary{background:#6c757d;}
textarea{width:100%;height:180px;padding:10px;border-radius:8px;resize:none;}
</style>
</head>

<body>

<!-- ================= DASHBOARD ================= -->
<% if (!roomId && !meeting) { %>

<div class="section">
  <h2>Start Video Session</h2>

  <% if (users && users.length > 0) { %>
    <% users.forEach(function(u){ %>
      <form method="POST" action="/video-counseling">
        <input type="hidden" name="counselorId" value="<%= u.id %>">
        <button class="btn">Start Session with <%= u.username %></button>
      </form>
    <% }) %>
  <% } else { %>
    <p>No users available.</p>
  <% } %>
</div>

<% if (pendingRequests && pendingRequests.length > 0) { %>
<div class="section">
  <h3>Pending Requests</h3>
  <% pendingRequests.forEach(function(p){ %>
    <form method="POST" action="/video-counseling/accept/<%= p.id %>">
      <button class="btn">Accept <%= p.username %></button>
    </form>
  <% }) %>
</div>
<% } %>

<% } %>

<!-- ================= VIDEO ROOM ================= -->
<% if (roomId || meeting) { %>

<div class="section">
  <h2>
  <% if (meeting) { %>
    <%= meeting.title %>
  <% } else { %>
    Counseling Session
  <% } %>
  </h2>

  <div class="videos" id="videoContainer">
    <video id="localVideo" autoplay muted playsinline></video>
  </div>

  <button class="btn" id="muteSelf">Mute / Unmute</button>

  <% if (typeof isHost !== 'undefined' && isHost) { %>
    <button class="btn secondary" id="muteAll">Mute All</button>
    <button class="btn danger" id="endMeeting">End Meeting</button>
  <% } %>
</div>

<% } %>

<script src="/socket.io/socket.io.js"></script>
<script>

var socket = io();
var userId = <%= userId || 0 %>;
var roomId = "<%= roomId || '' %>";
var meetingId = "<%= meeting ? meeting.id : '' %>";
var isHost = <%= (typeof isHost !== 'undefined' && isHost) ? 'true' : 'false' %>;

var localStream;
var peers = {};
var container = document.getElementById("videoContainer");

async function initMedia(){
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  document.getElementById("localVideo").srcObject = localStream;
}

if(roomId){
  socket.emit("join_room",{roomId:roomId,userId:userId});
}

if(meetingId){
  socket.emit("join_meeting",{meetingId:meetingId,userId:userId});
}

document.getElementById("muteSelf") &&
document.getElementById("muteSelf").addEventListener("click",function(){
  if(!localStream) return;
  localStream.getAudioTracks().forEach(function(t){
    t.enabled = !t.enabled;
  });
});

document.getElementById("endMeeting") &&
document.getElementById("endMeeting").addEventListener("click",function(){
  if(meetingId){
    socket.emit("end_meeting",{meetingId:meetingId});
  }else if(roomId){
    fetch("/video-counseling/end/"+roomId,{method:"POST"});
    window.location="/video-counseling";
  }
});

</script>

</body>
</html>