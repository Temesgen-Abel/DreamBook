<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <%- include('includes/head') %>
  <link rel="stylesheet" href="/style.css">

  <style>
    /* ===== Dashboard Sections ===== */
    .dashboard-section {
      margin-bottom: 30px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .videos {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }

    video {
      width: 300px;
      background: #000;
      border-radius: 10px;
    }

    .controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .meeting-link {
      background: #f1f3f5;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
    }

    .meeting-link input {
      width: 100%;
      padding: 5px;
    }

    #recordBtn {
      padding: 5px 10px;
    }
  </style>
</head>

<body>
  <%- include('includes/header') %>

  <div class="chat-layout">
    <div class="video-counseling">
      <h1>Video Counseling Dashboard</h1>

      <!-- =========================
           1-to-1 SESSION REQUEST
      ========================= -->
      <div class="dashboard-section">
        <h3>Request 1-to-1 Session</h3>
        <% if (users && users.length) { %>
          <form action="/video-counseling" method="POST">
            <select name="counselorId" required>
              <option value="">Select Counselor</option>
              <% users.forEach(u => { %>
                <option value="<%= u.id %>"><%= u.username %></option>
              <% }) %>
            </select>
            <button class="btn">Request Session</button>
          </form>
        <% } else { %>
          <p>No counselors available.</p>
        <% } %>
      </div>

      <!-- =========================
           GROUP MEETING CREATION
      ========================= -->
      <div class="dashboard-section">
        <h3>Group Counseling Session</h3>
        <p>Create a meeting and share the link with participants.</p>
        <form action="/live-meetings/create" method="POST">
          <input type="text" name="title" placeholder="Meeting Title" required>
          <button class="btn">Create Group Meeting</button>
        </form>
      </div>

      <!-- =========================
           PENDING REQUESTS (FOR COUNSELORS)
      ========================= -->
      <% if (pendingRequests && pendingRequests.length) { %>
      <div class="dashboard-section">
        <h3>Pending Session Requests</h3>
        <% pendingRequests.forEach(req => { %>
          <div style="margin-bottom:10px;">
            <strong><%= req.username %></strong> requested a session
            <form action="/video-counseling/accept/<%= req.id %>" method="POST" style="display:inline;">
              <button class="btn">Accept</button>
            </form>
          </div>
        <% }) %>
      </div>
      <% } %>

      <!-- =========================
           ACTIVE VIDEO SECTION
      ========================= -->
      <% if (roomId || meeting) { %>
      <hr>
      <h2><%= meeting ? meeting.title : "Live Video Counseling" %></h2>

      <% if (meeting && meeting.created_by === userId) { %>
        <div class="meeting-link">
          <strong>Share this link:</strong>
          <input value="<%= meeting.meeting_link %>" readonly>
          /* You can add a copy button here if desired *\

          <button class="btn" onclick="copyMeetingLink()">Copy Link</button>
          <script>
            function copyMeetingLink() {
              const input = document.querySelector(".meeting-link input");
              input.select();
              document.execCommand("copy");
              alert("Meeting link copied to clipboard!");
            }
          </script>

        </div>
      <% } %>

      <div class="videos">
        <video id="localVideo" autoplay muted playsinline></video>
      </div>

      <div class="controls">
        <button class="btn">Mute</button>
        <button class="btn">End</button>
        <button class="btn recordBtn">⏺️</button>
      </div>

      <script src="/socket.io/socket.io.js"></script>
          <script>
          const socket = io();
          const roomId = "<%= roomId || (meeting && meeting.id) %>";
          const userId = "<%= userId %>";
          const isGroup = <%= meeting ? "true" : "false" %>;

          const localVideo = document.getElementById("localVideo");
          const muteBtn = document.getElementById("muteBtn");
          const endBtn = document.getElementById("endBtn");
          const recordBtn = document.getElementById("recordBtn");

          let localStream;
          let peers = {}; // for group
          let peer = null; // for 1-to-1
          let isMuted = false;
          let isRecording = false;
          let mediaRecorder, recordedChunks = [];

          const config = {
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
          };

          /* =========================
            INITIALIZE MEDIA
          ========================= */
          async function init() {
            try {
              localStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
              });

              localVideo.srcObject = localStream;

              if (isGroup) {
                socket.emit("join_meeting", { meetingId: roomId, userId });
              } else {
                socket.emit("join_call", { roomId, userId });
              }
            } catch (err) {
              alert("Camera or microphone access denied.");
              console.error(err);
            }
          }

          init();

          /* =====================================================
            1️⃣  ONE-TO-ONE CALL LOGIC
          ===================================================== */

          socket.on("peer_joined", async ({ socketId }) => {

            peer = new RTCPeerConnection(config);

            localStream.getTracks().forEach(track => {
              peer.addTrack(track, localStream);
            });

            peer.ontrack = event => {
              addRemoteVideo(event.streams[0], socketId);
            };

            peer.onicecandidate = event => {
              if (event.candidate) {
                socket.emit("webrtc_ice_candidate", {
                  roomId,
                  candidate: event.candidate
                });
              }
            };

            const offer = await peer.createOffer();
            await peer.setLocalDescription(offer);

            socket.emit("webrtc_offer", { roomId, offer });
          });

          socket.on("webrtc_offer", async ({ offer }) => {

            peer = new RTCPeerConnection(config);

            localStream.getTracks().forEach(track => {
              peer.addTrack(track, localStream);
            });

            peer.ontrack = event => {
              addRemoteVideo(event.streams[0], "remote");
            };

            peer.onicecandidate = event => {
              if (event.candidate) {
                socket.emit("webrtc_ice_candidate", {
                  roomId,
                  candidate: event.candidate
                });
              }
            };

            await peer.setRemoteDescription(new RTCSessionDescription(offer));

            const answer = await peer.createAnswer();
            await peer.setLocalDescription(answer);

            socket.emit("webrtc_answer", { roomId, answer });
          });

          socket.on("webrtc_answer", async ({ answer }) => {
            if (peer) {
              await peer.setRemoteDescription(new RTCSessionDescription(answer));
            }
          });

          socket.on("webrtc_ice_candidate", async ({ candidate }) => {
            if (peer) {
              await peer.addIceCandidate(new RTCIceCandidate(candidate));
            }
          });

          /* =====================================================
            2️⃣  GROUP MEETING LOGIC
          ===================================================== */

          socket.on("user_joined", async ({ userId: newUserId, socketId }) => {

            const newPeer = new RTCPeerConnection(config);
            peers[socketId] = newPeer;

            localStream.getTracks().forEach(track => {
              newPeer.addTrack(track, localStream);
            });

            newPeer.ontrack = event => {
              addRemoteVideo(event.streams[0], socketId);
            };

            newPeer.onicecandidate = event => {
              if (event.candidate) {
                socket.emit("group_ice_candidate", {
                  candidate: event.candidate,
                  toSocketId: socketId
                });
              }
            };

            const offer = await newPeer.createOffer();
            await newPeer.setLocalDescription(offer);

            socket.emit("group_offer", {
              offer,
              toSocketId: socketId
            });
          });

          socket.on("group_offer", async ({ offer, fromSocketId }) => {

            const newPeer = new RTCPeerConnection(config);
            peers[fromSocketId] = newPeer;

            localStream.getTracks().forEach(track => {
              newPeer.addTrack(track, localStream);
            });

            newPeer.ontrack = event => {
              addRemoteVideo(event.streams[0], fromSocketId);
            };

            newPeer.onicecandidate = event => {
              if (event.candidate) {
                socket.emit("group_ice_candidate", {
                  candidate: event.candidate,
                  toSocketId: fromSocketId
                });
              }
            };

            await newPeer.setRemoteDescription(new RTCSessionDescription(offer));

            const answer = await newPeer.createAnswer();
            await newPeer.setLocalDescription(answer);

            socket.emit("group_answer", {
              answer,
              toSocketId: fromSocketId
            });
          });

          socket.on("group_answer", async ({ answer, fromSocketId }) => {
            if (peers[fromSocketId]) {
              await peers[fromSocketId].setRemoteDescription(
                new RTCSessionDescription(answer)
              );
            }
          });

          socket.on("group_ice_candidate", async ({ candidate, fromSocketId }) => {
            if (peers[fromSocketId]) {
              await peers[fromSocketId].addIceCandidate(
                new RTCIceCandidate(candidate)
              );
            }
          });

          socket.on("user_left", socketId => {
            if (peers[socketId]) {
              peers[socketId].close();
              delete peers[socketId];
            }
            removeRemoteVideo(socketId);
          });

          /* =====================================================
            VIDEO HELPERS
          ===================================================== */

          function addRemoteVideo(stream, id) {
            let video = document.getElementById("remote_" + id);

            if (!video) {
              video = document.createElement("video");
              video.id = "remote_" + id;
              video.autoplay = true;
              video.playsInline = true;
              document.querySelector(".videos").appendChild(video);
            }

            video.srcObject = stream;
          }

          function removeRemoteVideo(id) {
            const video = document.getElementById("remote_" + id);
            if (video) video.remove();
          }

          /* =====================================================
            CONTROLS
          ===================================================== */

          muteBtn.onclick = () => {
            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => {
              track.enabled = !isMuted;
            });
            muteBtn.innerText = isMuted ? "Unmute" : "Mute";
          };

          endBtn.onclick = () => {
            localStream.getTracks().forEach(track => track.stop());
            socket.disconnect();
            window.location.href = "/video-counseling";
          };

          /* =====================================================
            RECORDING
          ===================================================== */

          recordBtn.onclick = () => {
            if (!isRecording) {

              const combinedStream = new MediaStream();
              localStream.getTracks().forEach(t => combinedStream.addTrack(t));

              mediaRecorder = new MediaRecorder(combinedStream);

              mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) recordedChunks.push(e.data);
              };

              mediaRecorder.onstop = async () => {
                const blob = new Blob(recordedChunks, { type: "video/webm" });
                const formData = new FormData();
                formData.append("recording", blob);

                await fetch(`/live-meetings/${roomId}/upload-recording`, {
                  method: "POST",
                  body: formData
                });

                recordedChunks = [];
              };

              mediaRecorder.start();
              recordBtn.innerText = "Stop Recording";
              isRecording = true;

            } else {
              mediaRecorder.stop();
              recordBtn.innerText = "Start Recording";
              isRecording = false;
            }
          };

      </script>
      <% } %>
    </div>
  </div>
</body>
</html>