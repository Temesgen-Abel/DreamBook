<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <%- include('includes/head') %>
  <link rel="stylesheet" href="/style.css">

  <style>
    body { background:#f4f6f9; }
    .section {
      background:white;
      padding:20px;
      border-radius:10px;
      margin-bottom:20px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    .btn {
      padding:8px 14px;
      border:none;
      border-radius:6px;
      background:#2d89ef;
      color:white;
      cursor:pointer;
      margin-right:5px;
    }
    .btn-danger { background:#e74c3c; }
    .btn-warning { background:#f39c12; }
    .btn-success { background:#27ae60; }

    .videos {
      display:flex;
      gap:15px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:20px;
    }

    video {
      width:320px;
      background:black;
      border-radius:8px;
    }

    .participant {
      margin-bottom:8px;
      padding:8px;
      background:#fafafa;
      border-radius:6px;
    }
  </style>
</head>

<body>

<div class="container">

<!-- ================================================= -->
<!-- CREATE LIVE MEETING (ANYONE CAN CREATE) -->
<!-- ================================================= -->

<div class="section">
  <h3>Create Live Meeting</h3>

  <form action="/live-meetings/create" method="POST">
    <input type="text" name="title" placeholder="Meeting title" required>
    <input type="datetime-local" name="scheduled_at">
    <input type="number" name="duration" placeholder="Duration (minutes)">
    <button class="btn btn-success">Create Meeting</button>
  </form>
</div>

<!-- ================================================= -->
<!-- MEETING AREA -->
<!-- ================================================= -->

<% if (meeting) { %>

<div class="section">
  <h3><%= meeting.title %></h3>

  <p>
    <strong>Status:</strong> <%= meeting.status %>
  </p>

  <p>
    <strong>Meeting Link:</strong><br>
    <input type="text" value="<%= meeting.meeting_link %>" readonly style="width:100%;">
  </p>

  <div class="videos">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>
</div>

<!-- ================================================= -->
<!-- WAITING ROOM -->
<!-- ================================================= -->

<% if (isHost) { %>
<div class="section">
  <h3>Waiting Room</h3>

  <label>
    <input type="checkbox" id="autoAdmitToggle">
    Auto Admit Participants
  </label>

  <div id="waitingRoom"></div>
</div>
<% } %>

<!-- ================================================= -->
<!-- PARTICIPANTS MANAGEMENT -->
<!-- ================================================= -->

<% if (isHost) { %>
<div class="section">
  <h3>Participants (Host Controls)</h3>
  <div id="participantList"></div>
</div>
<% } %>

<!-- ================================================= -->
<!-- DOCUMENTS -->
<!-- ================================================= -->

<div class="section">
  <h3>Shared Documents</h3>

  <% if (isHost) { %>
    <form id="uploadDocForm" enctype="multipart/form-data">
      <input type="file" name="document" required>
      <button class="btn">Upload</button>
    </form>
  <% } %>

  <div id="docList"></div>
</div>

<!-- ================================================= -->
<!-- HOST ACTIONS -->
<!-- ================================================= -->

<% if (isHost) { %>
<div class="section">
  <h3>Meeting Controls</h3>

  <button class="btn btn-warning" id="muteAllBtn">Mute All</button>
  <button class="btn btn-danger" id="endMeetingBtn">End Meeting For Everyone</button>
</div>
<% } %>

<% } %>

</div>


<!-- ================================================= -->
<!-- SOCKET + MEETING LOGIC -->
<!-- ================================================= -->

<% if (meeting) { %>
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const meetingId = "<%= meeting.id %>";
  const userId = "<%= userId %>";
  const isHost = <%= isHost ? "true" : "false" %>;

  socket.emit("join_meeting", { meetingId, userId });

  /* ===============================
     WAITING ROOM LOGIC
  =============================== */

  socket.on("waiting_user", (data) => {
    if (!isHost) return;

    const container = document.getElementById("waitingRoom");

    if (document.getElementById("autoAdmitToggle").checked) {
      socket.emit("approve_user", data);
      return;
    }

    const div = document.createElement("div");
    div.className = "participant";
    div.innerHTML = `
      ${data.username}
      <button onclick='approve("${data.userId}")' class="btn btn-success">Accept</button>
      <button onclick='reject("${data.userId}")' class="btn btn-danger">Reject</button>
    `;
    container.appendChild(div);
  });

  function approve(id){
    socket.emit("approve_user", { meetingId, userId:id });
  }

  function reject(id){
    socket.emit("reject_user", { meetingId, userId:id });
  }

  /* ===============================
     PARTICIPANT LIST (HOST)
  =============================== */

  socket.on("participant_joined", (data) => {
    if (!isHost) return;

    const list = document.getElementById("participantList");

    const div = document.createElement("div");
    div.className = "participant";
    div.id = "p_" + data.userId;

    div.innerHTML = `
      ${data.username}
      <button onclick='mute("${data.userId}")' class="btn btn-warning">Mute</button>
      <button onclick='removeUser("${data.userId}")' class="btn btn-danger">Remove</button>
    `;

    list.appendChild(div);
  });

  function mute(id){
    socket.emit("mute_user", { meetingId, userId:id });
  }

  function removeUser(id){
    socket.emit("remove_user", { meetingId, userId:id });
  }

  /* ===============================
     MUTE ALL
  =============================== */

  if (isHost) {
    document.getElementById("muteAllBtn")?.addEventListener("click", ()=>{
      socket.emit("mute_all", { meetingId });
    });

    document.getElementById("endMeetingBtn")?.addEventListener("click", ()=>{
      socket.emit("end_meeting", { meetingId });
    });
  }

  socket.on("meeting_ended", ()=>{
    alert("Meeting has ended by host.");
    window.location.href = "/video-counseling";
  });

  /* ===============================
     DOCUMENT UPLOAD
  =============================== */

  document.getElementById("uploadDocForm")?.addEventListener("submit", async function(e){
    e.preventDefault();

    const formData = new FormData(this);

    await fetch(`/live-meetings/${meetingId}/upload-doc`, {
      method: "POST",
      body: formData
    });

    this.reset();
  });

  socket.on("refresh_docs", ()=>{
    location.reload();
  });

</script>
<% } %>

</body>
</html>